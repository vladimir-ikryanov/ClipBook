# ClipSync - Server API Specification

## Overview

RESTful API with WebSocket support for real-time clipboard synchronization.

---

## Base URL

```
Production:  https://api.clipsync.app/v1
Development: http://localhost:8080/v1
WebSocket:   wss://api.clipsync.app/v1/ws
```

---

## Authentication

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       AUTHENTICATION MODEL                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│    Device-based authentication (no user accounts required)                  │
│                                                                             │
│    Header Format:                                                           │
│    Authorization: Bearer <device_token>                                     │
│                                                                             │
│    Token Generation:                                                        │
│    • Generated during device registration                                   │
│    • Signed with device's private key                                       │
│    • Verified using device's public key                                     │
│                                                                             │
│    Optional: User accounts for multi-device management                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Endpoints

### Device Management

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  POST /devices/register                                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Register a new device                                                      │
│                                                                             │
│  Request Body:                                                              │
│  ─────────────────────────────────────────                                  │
│  device_id          string    UUID generated by device                      │
│  device_name        string    User-friendly name                            │
│  platform           string    macos | windows | android | ios               │
│  identity_key       string    Base64 encoded public key                     │
│  signed_prekey      object    Pre-key for Signal Protocol                   │
│    └─ key_id        number    Key identifier                                │
│    └─ public_key    string    Base64 encoded                                │
│    └─ signature     string    Base64 encoded                                │
│  one_time_prekeys   array     Array of one-time pre-keys                    │
│    └─ key_id        number    Key identifier                                │
│    └─ public_key    string    Base64 encoded                                │
│                                                                             │
│  Response:                                                                  │
│  ─────────────────────────────────────────                                  │
│  device_token       string    Auth token for this device                    │
│  server_time        number    Server timestamp                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  GET /devices/{device_id}/keys                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Get public keys for a device (for session establishment)                   │
│                                                                             │
│  Response:                                                                  │
│  ─────────────────────────────────────────                                  │
│  identity_key       string    Device's identity public key                  │
│  signed_prekey      object    Current signed pre-key                        │
│  one_time_prekey    object    One pre-key (consumed after use)              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  PUT /devices/{device_id}/keys                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Update/replenish device keys                                               │
│                                                                             │
│  Request Body:                                                              │
│  ─────────────────────────────────────────                                  │
│  signed_prekey      object    New signed pre-key (optional)                 │
│  one_time_prekeys   array     Additional one-time keys                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  GET /devices                                                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  List all paired devices                                                    │
│                                                                             │
│  Response:                                                                  │
│  ─────────────────────────────────────────                                  │
│  devices            array     List of paired devices                        │
│    └─ device_id     string    Device identifier                             │
│    └─ device_name   string    User-friendly name                            │
│    └─ platform      string    Platform type                                 │
│    └─ last_seen     number    Last activity timestamp                       │
│    └─ is_online     boolean   Currently connected                           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  DELETE /devices/{device_id}                                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Remove a device (remote logout)                                            │
│                                                                             │
│  Response:                                                                  │
│  ─────────────────────────────────────────                                  │
│  success            boolean   Operation result                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Message Relay

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  POST /messages                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Send encrypted message to other devices                                    │
│                                                                             │
│  Request Body:                                                              │
│  ─────────────────────────────────────────                                  │
│  recipient_ids      array     Target device IDs                             │
│  message_type       string    clip | ack | typing                           │
│  encrypted_payload  string    Base64 E2E encrypted content                  │
│  ttl                number    Time-to-live in seconds (optional)            │
│                                                                             │
│  Response:                                                                  │
│  ─────────────────────────────────────────                                  │
│  message_id         string    Unique message identifier                     │
│  timestamp          number    Server timestamp                              │
│  delivered_to       number    Number of online recipients                   │
│  queued_for         number    Number of offline recipients                  │
│                                                                             │
│  Note: Server cannot decrypt encrypted_payload                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  GET /messages                                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Fetch pending messages                                                     │
│                                                                             │
│  Query Parameters:                                                          │
│  ─────────────────────────────────────────                                  │
│  since              number    Timestamp to fetch from (optional)            │
│  limit              number    Max messages to return (default: 100)         │
│                                                                             │
│  Response:                                                                  │
│  ─────────────────────────────────────────                                  │
│  messages           array     List of pending messages                      │
│    └─ message_id    string    Message identifier                            │
│    └─ sender_id     string    Sending device ID                             │
│    └─ message_type  string    Message type                                  │
│    └─ encrypted_payload string Encrypted content                            │
│    └─ timestamp     number    When sent                                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  DELETE /messages/{message_id}                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Acknowledge message receipt (deletes from server)                          │
│                                                                             │
│  Response:                                                                  │
│  ─────────────────────────────────────────                                  │
│  success            boolean   Operation result                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Device Pairing

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  POST /pairing/initiate                                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Start pairing process (generates QR code data)                             │
│                                                                             │
│  Response:                                                                  │
│  ─────────────────────────────────────────                                  │
│  pairing_code       string    Short code for verification                   │
│  pairing_token      string    Token for QR code                             │
│  expires_at         number    Expiration timestamp                          │
│  qr_data            string    Data to encode in QR code                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  POST /pairing/complete                                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Complete pairing (after scanning QR code)                                  │
│                                                                             │
│  Request Body:                                                              │
│  ─────────────────────────────────────────                                  │
│  pairing_token      string    Token from QR code                            │
│  device_id          string    New device's ID                               │
│  device_name        string    New device's name                             │
│  platform           string    New device's platform                         │
│  identity_key       string    New device's public key                       │
│                                                                             │
│  Response:                                                                  │
│  ─────────────────────────────────────────                                  │
│  success            boolean   Pairing result                                │
│  initiator_device   object    Details of initiating device                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## WebSocket Protocol

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       WEBSOCKET CONNECTION                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Connection URL:                                                            │
│  wss://api.clipsync.app/v1/ws?token={device_token}                         │
│                                                                             │
│  Heartbeat:                                                                 │
│  • Client sends ping every 30 seconds                                       │
│  • Server responds with pong                                                │
│  • Connection closed after 60s without heartbeat                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### WebSocket Messages

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  SERVER → CLIENT Messages                                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  new_message                                                                │
│  ─────────────────────────────────────────                                  │
│  type               string    "new_message"                                 │
│  message_id         string    Message identifier                            │
│  sender_id          string    Sending device                                │
│  message_type       string    clip | ack                                    │
│  encrypted_payload  string    E2E encrypted content                         │
│  timestamp          number    Server timestamp                              │
│                                                                             │
│  device_online                                                              │
│  ─────────────────────────────────────────                                  │
│  type               string    "device_online"                               │
│  device_id          string    Device that came online                       │
│                                                                             │
│  device_offline                                                             │
│  ─────────────────────────────────────────                                  │
│  type               string    "device_offline"                              │
│  device_id          string    Device that went offline                      │
│                                                                             │
│  delivery_receipt                                                           │
│  ─────────────────────────────────────────                                  │
│  type               string    "delivery_receipt"                            │
│  message_id         string    Delivered message ID                          │
│  device_id          string    Device that received it                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  CLIENT → SERVER Messages                                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  send_message                                                               │
│  ─────────────────────────────────────────                                  │
│  type               string    "send_message"                                │
│  recipient_ids      array     Target devices                                │
│  message_type       string    clip | ack                                    │
│  encrypted_payload  string    E2E encrypted content                         │
│                                                                             │
│  acknowledge                                                                │
│  ─────────────────────────────────────────                                  │
│  type               string    "acknowledge"                                 │
│  message_ids        array     Messages to acknowledge                       │
│                                                                             │
│  ping                                                                       │
│  ─────────────────────────────────────────                                  │
│  type               string    "ping"                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Encrypted Payload Format

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    ENCRYPTED PAYLOAD STRUCTURE                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  After decryption, payload contains:                                        │
│                                                                             │
│  CLIP MESSAGE                                                               │
│  ─────────────────────────────────────────                                  │
│  id                 string    Unique clip identifier                        │
│  content_type       string    text | image | link | color                   │
│  content            string    Text content (for text/link/color)            │
│  binary_ref         string    Reference ID (for images)                     │
│  metadata           object    Additional info                               │
│    └─ source_app    string    App where copied (if available)               │
│    └─ source_device string    Device ID                                     │
│    └─ created_at    number    Timestamp                                     │
│    └─ hash          string    Content hash for dedup                        │
│                                                                             │
│  IMAGE TRANSFER (Large Files)                                               │
│  ─────────────────────────────────────────                                  │
│  For images and large content:                                              │
│  1. Content encrypted with random AES-256 key                               │
│  2. Encrypted blob uploaded to server                                       │
│  3. AES key sent in clip message (E2E encrypted)                            │
│  4. Recipient downloads blob, decrypts with key                             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Error Responses

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        ERROR CODES                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  HTTP Status    Error Code              Description                         │
│  ─────────────────────────────────────────────────────────────────────     │
│  400            invalid_request         Malformed request body              │
│  401            unauthorized            Invalid or missing token            │
│  403            forbidden               Action not allowed                  │
│  404            not_found               Resource doesn't exist              │
│  409            conflict                Device already registered           │
│  429            rate_limited            Too many requests                   │
│  500            server_error            Internal server error               │
│                                                                             │
│  Response Format:                                                           │
│  ─────────────────────────────────────────                                  │
│  error                object                                                │
│    └─ code            string    Error code                                  │
│    └─ message         string    Human-readable message                      │
│    └─ details         object    Additional info (optional)                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Rate Limits

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        RATE LIMITS                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Endpoint                     Limit                                         │
│  ─────────────────────────────────────────────────────────────────────     │
│  POST /devices/register       5 per hour per IP                             │
│  POST /messages               100 per minute per device                     │
│  GET /messages                60 per minute per device                      │
│  WebSocket messages           200 per minute per connection                 │
│                                                                             │
│  Rate limit headers:                                                        │
│  X-RateLimit-Limit            Max requests in window                        │
│  X-RateLimit-Remaining        Requests remaining                            │
│  X-RateLimit-Reset            Timestamp when limit resets                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Push Notifications

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    PUSH NOTIFICATION FORMAT                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Sent when device is offline and new message arrives                        │
│                                                                             │
│  FCM (Android) / APNs (iOS) Payload:                                        │
│  ─────────────────────────────────────────                                  │
│  notification       object    (Optional - for display)                      │
│    └─ title         string    "New clipboard sync"                          │
│    └─ body          string    "From [device_name]"                          │
│  data               object    (Always present)                              │
│    └─ type          string    "new_clip"                                    │
│    └─ message_count number    Pending messages count                        │
│                                                                             │
│  Note: Actual content is NOT in push notification                           │
│        App must connect to fetch and decrypt                                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Summary

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          API SUMMARY                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Device Management:                                                         │
│  POST   /devices/register              Register new device                  │
│  GET    /devices/{id}/keys             Get device public keys               │
│  PUT    /devices/{id}/keys             Update device keys                   │
│  GET    /devices                       List paired devices                  │
│  DELETE /devices/{id}                  Remove device                        │
│                                                                             │
│  Messaging:                                                                 │
│  POST   /messages                      Send encrypted message               │
│  GET    /messages                      Fetch pending messages               │
│  DELETE /messages/{id}                 Acknowledge receipt                  │
│                                                                             │
│  Pairing:                                                                   │
│  POST   /pairing/initiate              Start pairing                        │
│  POST   /pairing/complete              Complete pairing                     │
│                                                                             │
│  WebSocket:                                                                 │
│  ws://  /ws                            Real-time sync                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```
